#
# Cookbook Name:: db_mysql
#
# Copyright RightScale, Inc. All rights reserved.
# All access and use subject to the RightScale Terms of Service available at
# http://www.rightscale.com/terms.php and, if applicable, other agreements
# such as a RightScale Master Subscription Agreement.
#
# Managed by RightScale
# DO NOT EDIT BY HAND
#

# Generated by Chef for <%= node[:hostname] %>
#
# Local modifications will be overwritten.
#
# The MySQL database server configuration file.
#
# For explanations see
# http://dev.mysql.com/doc/mysql/en/server-system-variables.html

[client]
port            = 3306
socket          = <%= node[:db][:socket] %>

[mysqld_safe]
socket          = <%= node[:db][:socket] %>
nice            = 0

[mysqld]
#
# * Basic Settings
#
user            = mysql
#pid-file        = /var/run/mysqld/mysqld.pid
socket          = <%= node[:db][:socket] %>
port            = 3306
datadir         = <%= node[:db_mysql][:datadir] %>
tmpdir          = <%= node[:db_mysql][:tmpdir] %>

skip-external-locking
bind-address            = <%= node[:db_mysql][:bind_address] %>
#
# * Fine Tuning
#
key_buffer              = <%= node[:db_mysql][:tunable][:key_buffer] %>
max_allowed_packet      = 16M
thread_stack            = 192K
thread_cache_size       = <%= node[:db_mysql][:tunable][:thread_cache_size] %>
myisam-recover          = BACKUP
max_connections         = <%= node[:db_mysql][:tunable][:max_connections] %>
wait_timeout            = <%= node[:db_mysql][:tunable][:wait_timeout] %>
net_read_timeout        = <%= node[:db_mysql][:tunable][:net_read_timeout] %>
net_write_timeout       = <%= node[:db_mysql][:tunable][:net_write_timeout] %>
back_log                = <%= node[:db_mysql][:tunable][:back_log] %>
table_cache             = <%= node[:db_mysql][:tunable][:table_cache] %>
max_heap_table_size     = <%= node[:db_mysql][:tunable][:max_heap_table_size] %>

sort_buffer_size        = <%= node[:db_mysql][:tunable][:sort_buffer_size] %>
read_buffer_size        = <%= node[:db_mysql][:tunable][:read_buffer_size] %>
read_rnd_buffer_size    = <%= node[:db_mysql][:tunable][:read_rnd_buffer_size] %>
myisam_sort_buffer_size = <%= node[:db_mysql][:tunable][:myisam_sort_buffer_size] %>
net_buffer_length       = <%= node[:db_mysql][:tunable][:net_buffer_length] %>

#
# * Query Cache Configuration
#
query_cache_limit       = 1M
query_cache_size        = <%= node[:db_mysql][:tunable][:query_cache_size] %>

#
# * Logging and Replication
#
<%= node[:db_mysql][:log] %>
<%= node[:db_mysql][:log_error] %>
<%= node[:db_mysql][:tunable][:log_slow_queries] %>
<%= node[:db_mysql][:tunable][:long_query_time] %>
log-queries-not-using-indexes

<%= "read_only = 1" unless node[:db_mysql][:tunable][:read_only] == nil %>
server-id               = <%= @server_id %>
<% if node[:db_mysql][:log_bin_enabled] %>
<%= "log_bin = #{node[:db_mysql][:log_bin]}" %>
<%= "expire_logs_days        = #{node[:db_mysql][:tunable][:expire_logs_days]}" %>
<% end %>
binlog_format           = <%= node[:db_mysql][:binlog_format] %>
max_binlog_size         = 100M

slave-net-timeout = <%= @slave_net_timeout %>

#
# * InnoDB
#

innodb_data_home_dir = /var/lib/mysql/
innodb_data_file_path = ibdata1:10M:autoextend
innodb_log_group_home_dir = /var/lib/mysql

<% if node[:db][:version] == '5.5' %>
# some MySQL 5.5 specific config
<% end %>

<% if node[:db][:version].to_i == 10 %>
# some MySQL 10.0 specific config
<% end %>

innodb_file_per_table
innodb_buffer_pool_size = <%= node[:db_mysql][:tunable][:innodb_buffer_pool_size] %>
innodb_additional_mem_pool_size = <%= node[:db_mysql][:tunable][:innodb_additional_mem_pool_size] %>
innodb_log_file_size = <%= @innodb_log_file_size %>
innodb_log_buffer_size = <%= node[:db_mysql][:tunable][:innodb_log_buffer_size] %>
innodb_flush_log_at_trx_commit = 2
innodb_lock_wait_timeout = 50
innodb_support_xa = 1
innodb_flush_method=O_DIRECT
innodb_fast_shutdown = 1


<% if node[:db][:version].to_f < 5.5 && node[:db][:flavor] == "mariadb" %>
# MariaDB #{node[:db][:version]} Percona tuning

innodb_stats_update_need_lock = 0
innodb_adaptive_checkpoint=estimate
innodb_use_purge_thread = 1
innodb_doublewrite = true
innodb_adaptive_flushing=false
innodb_ibuf_active_contract = 1

innodb_extra_undoslots=<%= node[:db_mysql][:tunable][:innodb_extra_undoslots] %>
innodb_fast_recovery = 1
innodb_use_purge_thread = 1
<% end %>

<% if node[:db][:flavor] == "mariadb" && node[:db][:version].to_f == 5.5 %>
innodb_adaptive_flushing_method = estimate
innodb_purge_threads = 1
innodb_change_buffering = all
innodb-fast-checksum = 1
innodb_large_prefix = 1
innodb_stats_update_need_lock = 0
<% end %>

<% if node[:db][:flavor] == "mariadb" && node[:db][:version].to_f >= 5.5 %>
innodb_purge_threads = 1
innodb_change_buffering = all
innodb_large_prefix = 1
<% end %>



log-bin=<%=node[:db_mysql][:log_bin] %>
relay-log-index=<%= node[:db][:data_dir] %>/<%= @relay_log %>-relay-log.index
relay-log=<%= node[:db][:data_dir] %>/<%= @relay_log %>-relay-bin

slave_compressed_protocol = <%= @compressed_protocol %>

<% if @ssl_enabled %>
#
# * SSL
#
ssl
ssl-ca = <%= @ca_certificate %>
ssl-cert = <%= @master_certificate %>
ssl-key = <%= @master_key %>
<% end %>

[mysqldump]
quick
quote-names
max_allowed_packet      = 16M

[mysql]

[myisamchk]
key_buffer        = <%= node[:db_mysql][:tunable][:myisamchk][:key_buffer] %>
sort_buffer_size        = <%= node[:db_mysql][:tunable][:myisamchk][:sort_buffer_size] %>
